{% extends "saving/base.html" %}
{% load humanize tz %}

{% load static %}

{% block title %}ホーム{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'saving/home.css' %}">
{% endblock %}

{% block header_title %}ホーム{% endblock %}

{% block content %}
<div class="home-container">
    <div class="home-top-row">
        <div class="saving-today-box">
            <h2>今日の貯金額</h2>
            <div class="saving-today-card card">
                <h3>本日の貯金額</h3>
                <div class="amount-box">
                    <p class="amount-symbol">¥</p>
                    <p class="amount-value">{{ today_saving|intcomma }}</p>
                </div>
                <h3 class="saving-title">今月の貯金額</h3>
                <div class="amount-box">
                    <p class="amount-symbol">¥</p>
                    <p class="amount-value">{{ month_saving|intcomma }}</p>
                </div>
                <div class="saving-days">
                    <p class="saving-count">{{ current_streak }}</p>
                    <p class="saving-label">日連続貯金しました</p>
                </div>
                <a href="{% url 'saving_list' %}" class="saving-btn">
                    <span class="btn-plus">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                            <path d="M12 4v16M4 12h16" stroke="#ffffff" stroke-width="3" stroke-linecap="round" />
                        </svg>
                    </span>
                    貯金する
                </a>
            </div>
        </div>
        <div class="saving-goal-box">
            <h2>貯金目標</h2>
            <div class="saving-goal-card card">
                <h3>目標金額</h3>
                <div class="goal-amount-box">
                    <p class="goal-amount-symbol">¥</p>
                    <p class="goal-amount-value">{{ target_amount|intcomma }}</p>
                </div>
                <h3 class="saving-title">貯金金額</h3>
                <div class="saved-amount-box">
                    <p class="saved-amount-symbol">¥</p>
                    <p class="saved-amount-value">{{ total_saving|intcomma }}</p>
                </div>
                <div class="circle-wrapper">
                    <div class="progress-circle" style="--rate: {{ achievement_rate }};">
                        <div class="progress-inner">
                            {% if achievement_rate >= 100 %}
                            <p class="progress-text">完了</p>
                            {% else %}
                            <p class="progress-text">{{ achievement_rate }}%</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="saving-history-box">
        <div class="saving-tabs">
            <button class="tab-btn active" data-tab="history">貯金履歴</button>
            <button class="tab-btn" data-tab="progress">進捗グラフ</button>
        </div>
        <div class="tab-contents">
            <!-- 貯金履歴 -->
            <div class="tab-content active" id="history">
                <div class="saving-history-card card">
                    <ul class="history-list">
                        {% for day in saving_history %}
                        <li class="history-item">
                            <div class="history-header">
                                <div class="history-main">
                                    <p class="history-date">{{ day.date|date:"m/d" }}</p>
                                    <p class="history-amount">¥{{ day.total|intcomma }}</p>
                                </div>
                                <i class="fa-solid fa-angle-down history-toggle"></i>
                            </div>
                            <div class="history-body">
                                <div class="history-body-inner">
                                    <ul class="history-detail-list">
                                        {% for record in day.records %}
                                        <li>
                                            <div class="detail-item">
                                                <div>
                                                    <p class="detail-label">{{ record.method.method_name }}</p>
                                                </div>
                                                <div>
                                                    <p class="detail-value">¥{{ record.amount|intcomma }}</p>
                                                </div>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <!-- 進捗グラフ -->
            <div class="tab-content" id="progress">
                <div class="saving-progress-card card">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const target = btn.dataset.tab;
            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === target);
            });
        });
    });


    document.querySelectorAll('.history-header').forEach(header => {
        header.addEventListener('click', () => {
            const item = header.parentElement;
            const isOpen = item.classList.contains('open');
            document.querySelectorAll('.history-item')
                .forEach(i => i.classList.remove('open'));
            if (!isOpen) {
                item.classList.add('open');
            }
        });
    });

    // 進捗グラフの描画
    const chartScript = document.createElement('script');
    chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
    document.head.appendChild(chartScript);

    chartScript.onload = function () {
        const historyData = {{ graph_data| safe
    }};
    const ctx = document.getElementById('progressChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: historyData.labels,
            datasets: [{
                label: '貯金額（円）',
                data: historyData.data,
                borderColor: '#d7a640',
                backgroundColor: 'rgba(215, 166, 64, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#d7a640',
                pointBorderColor: '#af8118',
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                    }
                }
            }
        }
    });
    };

</script>
{% endblock %}